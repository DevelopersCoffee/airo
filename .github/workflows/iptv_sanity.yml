name: IPTV Sanity Pipeline

on:
  # Scheduled: Run daily at 00:00 UTC
  schedule:
    - cron: '0 0 * * *'

  # Manual trigger
  workflow_dispatch:
    inputs:
      skip_validation:
        description: 'Skip stream validation (faster)'
        required: false
        default: 'false'
        type: boolean

  # On push to iptv-data changes
  push:
    branches:
      - main
    paths:
      - 'iptv-data/config/**'
      - 'iptv-data/rules/**'
      - 'iptv-data/src/**'

env:
  PYTHON_VERSION: '3.11'
  WORKING_DIR: iptv-data
  # Gist ID for publishing IPTV data (create a public gist and set this)
  GIST_ID: ${{ secrets.IPTV_GIST_ID }}

jobs:
  pipeline:
    name: Run IPTV Pipeline
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'iptv-data/requirements.txt'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run linting
        run: |
          pip install ruff
          ruff check src/
      
      - name: Run tests
        run: |
          pytest tests/ -v --tb=short
      
      - name: Run pipeline
        id: pipeline
        run: |
          if [ "${{ github.event.inputs.skip_validation }}" == "true" ]; then
            python -m src.main --config config/default.yaml --skip-validation
          else
            python -m src.main --config config/default.yaml
          fi
      
      - name: Verify output
        run: |
          # Check that output files exist
          test -f output/current/iptv_channels.json
          test -f output/current/manifest.json
          
          # Validate JSON
          python -c "import json; json.load(open('output/current/iptv_channels.json'))"
          
          # Check minimum channel count
          CHANNEL_COUNT=$(python -c "import json; d=json.load(open('output/current/iptv_channels.json')); print(len(d['channels']))")
          echo "Channel count: $CHANNEL_COUNT"
          
          if [ "$CHANNEL_COUNT" -lt 50 ]; then
            echo "Error: Channel count ($CHANNEL_COUNT) below minimum threshold (50)"
            exit 1
          fi
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: iptv-data-${{ github.run_number }}
          path: |
            iptv-data/output/current/
            iptv-data/output/reports/
          retention-days: 30

      - name: Publish to GitHub Gist
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: |
          # Get version from manifest
          VERSION=$(python -c "import json; print(json.load(open('output/current/manifest.json'))['version'])")
          echo "Publishing IPTV data v${VERSION} to Gist..."

          # Read file contents and escape for JSON
          CHANNELS_CONTENT=$(python -c "import json; print(json.dumps(open('output/current/iptv_channels.json').read()))")
          MANIFEST_CONTENT=$(python -c "import json; print(json.dumps(open('output/current/manifest.json').read()))")
          M3U_CONTENT=$(python -c "import json; print(json.dumps(open('output/current/iptv_channels.m3u').read()))")

          # Create JSON payload for Gist update
          cat > /tmp/gist_payload.json << EOF
          {
            "description": "IPTV Channels Data v${VERSION} - Auto-updated by IPTV Sanity Pipeline",
            "files": {
              "iptv_channels.json": {
                "content": ${CHANNELS_CONTENT}
              },
              "manifest.json": {
                "content": ${MANIFEST_CONTENT}
              },
              "iptv_channels.m3u": {
                "content": ${M3U_CONTENT}
              }
            }
          }
          EOF

          # Update the Gist using GitHub API
          curl -X PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GIST_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/gists/${{ env.GIST_ID }}" \
            -d @/tmp/gist_payload.json

          echo "âœ… Published to Gist: https://gist.github.com/${{ env.GIST_ID }}"

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: pipeline
    if: failure()
    
    steps:
      - name: Log failure
        run: |
          echo "IPTV Pipeline failed! Manual intervention may be required."
          echo "Check the pipeline logs for details."

