# =============================================================================
# PR Checks Workflow - Optimized for Fast Feedback
# =============================================================================
# This workflow is designed to provide fast feedback on PRs (<5 minutes)
# More comprehensive checks (coverage, security scans, builds) run in the
# release workflow or on push to main.
# =============================================================================
name: PR Checks

on:
  pull_request:
    branches: [ main, master, develop ]

# Cancel any in-progress runs for the same PR
concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.35.7'

jobs:
  # ============================================
  # PR Validation (fast checks) - ~15 seconds
  # ============================================
  pr-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Validate PR title
        uses: amannn/action-semantic-pull-request@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check file changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            flutter:
              - 'app/**'
              - 'packages/**'
            docs:
              - '**.md'

  # ============================================
  # Code Quality (analyze, format) - ~2 minutes
  # ============================================
  code-quality:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.pub-cache
            app/.dart_tool
            packages/*/.dart_tool
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-

      - name: Get dependencies (parallel)
        run: |
          (cd packages/core_domain && flutter pub get) &
          (cd packages/core_ui && flutter pub get) &
          (cd packages/core_data && flutter pub get) &
          (cd packages/core_ai && flutter pub get) &
          (cd packages/core_auth && flutter pub get) &
          wait
          cd app && flutter pub get

      - name: Run code generation
        run: |
          cd app
          dart run build_runner build --delete-conflicting-outputs

      - name: Run Flutter Analyze
        run: |
          cd app
          flutter analyze --no-fatal-infos --no-fatal-warnings

      - name: Check formatting
        run: |
          cd app
          find lib test -name "*.dart" ! -name "*.g.dart" ! -name "*.freezed.dart" -print0 | xargs -0 dart format --set-exit-if-changed

  # ============================================
  # Fast Unit Tests (core packages only) - ~2 minutes
  # App tests and coverage moved to release workflow
  # ============================================
  tests:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.pub-cache
            packages/*/.dart_tool
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-

      - name: Get core package dependencies (parallel)
        run: |
          (cd packages/core_domain && flutter pub get) &
          (cd packages/core_ui && flutter pub get) &
          (cd packages/core_data && flutter pub get) &
          (cd packages/core_ai && flutter pub get) &
          (cd packages/core_auth && flutter pub get) &
          wait

      - name: Run core package tests (parallel)
        run: |
          echo "Running core package tests in parallel..."
          (cd packages/core_domain && flutter test --reporter=compact) &
          (cd packages/core_data && flutter test --reporter=compact) &
          (cd packages/core_ai && flutter test --reporter=compact) &
          (cd packages/core_auth && flutter test --reporter=compact) &
          wait
          echo "All core package tests completed!"

  # ============================================
  # PR Summary Comment
  # ============================================
  pr-summary:
    runs-on: ubuntu-latest
    needs: [pr-validation, code-quality, tests]
    if: always()
    steps:
      - name: Comment PR with summary
        uses: actions/github-script@v8
        with:
          script: |
            const prValidation = '${{ needs.pr-validation.result }}';
            const codeQuality = '${{ needs.code-quality.result }}';
            const tests = '${{ needs.tests.result }}';

            const getEmoji = (status) => status === 'success' ? 'âœ…' : status === 'skipped' ? 'â­ï¸' : 'âŒ';

            const comment = `## ðŸš€ PR Quick Check Summary

            | Check | Status | Description |
            |-------|--------|-------------|
            | PR Validation | ${getEmoji(prValidation)} ${prValidation} | Title format, file changes |
            | Code Quality | ${getEmoji(codeQuality)} ${codeQuality} | Analyze, formatting |
            | Core Tests | ${getEmoji(tests)} ${tests} | Core package unit tests |

            > ðŸ’¡ **Note:** Full app tests, coverage reports, and security scans run on merge to main.

            [View Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
