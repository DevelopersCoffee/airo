name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
      prerelease:
        description: 'Is this a pre-release?'
        required: false
        default: false
        type: boolean

env:
  FLUTTER_VERSION: '3.35.7'

jobs:
  # ============================================
  # Generate Changelog
  # ============================================
  changelog:
    runs-on: ubuntu-latest
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        id: changelog
        uses: orhun/git-cliff-action@v3
        with:
          config: cliff.toml
          args: --latest --strip header
        continue-on-error: true

      - name: Fallback changelog
        if: steps.changelog.outcome == 'failure'
        run: |
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "## What's Changed" >> $GITHUB_OUTPUT
          git log --oneline -20 >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # ============================================
  # Build Android (APK + AAB)
  # ============================================
  build-android:
    runs-on: ubuntu-latest
    needs: changelog
    steps:
      - uses: actions/checkout@v6

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v5
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-

      - name: Cache Gradle
        uses: actions/cache@v5
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: gradle-${{ runner.os }}-

      - name: Create Firebase Config
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        if: env.GOOGLE_SERVICES_JSON != ''
        run: |
          cd app
          echo '${{ secrets.GOOGLE_SERVICES_JSON }}' | base64 -d > android/app/google-services.json

      - name: Get dependencies
        run: |
          cd packages/core_domain && flutter pub get
          cd ../core_ui && flutter pub get
          cd ../core_data && flutter pub get
          cd ../core_ai && flutter pub get
          cd ../core_auth && flutter pub get
          cd ../../app && flutter pub get

      - name: Build APK (Release)
        run: |
          cd app
          flutter build apk --release \
            --dart-define=ENV=prod \
            --dart-define=DEMO_MODE=false

      - name: Build AAB (Release)
        run: |
          cd app
          flutter build appbundle --release \
            --dart-define=ENV=prod \
            --dart-define=DEMO_MODE=false

      - name: Upload APK
        uses: actions/upload-artifact@v5
        with:
          name: android-apk
          path: app/build/app/outputs/flutter-apk/app-release.apk

      - name: Upload AAB
        uses: actions/upload-artifact@v5
        with:
          name: android-aab
          path: app/build/app/outputs/bundle/release/app-release.aab

  # ============================================
  # Build iOS
  # ============================================
  build-ios:
    runs-on: macos-latest
    needs: changelog
    steps:
      - uses: actions/checkout@v6

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v5
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-

      - name: Get dependencies
        run: |
          cd packages/core_domain && flutter pub get
          cd ../core_ui && flutter pub get
          cd ../core_data && flutter pub get
          cd ../core_ai && flutter pub get
          cd ../core_auth && flutter pub get
          cd ../../app && flutter pub get

      - name: Build iOS
        run: |
          cd app
          flutter build ios --release --no-codesign \
            --dart-define=ENV=prod \
            --dart-define=DEMO_MODE=false

      - name: Create IPA
        run: |
          cd app/build/ios/Release-iphoneos
          mkdir -p Payload
          mv Runner.app Payload/
          zip -r -q app-release.ipa Payload
          mv app-release.ipa ../../../

      - name: Upload IPA
        uses: actions/upload-artifact@v5
        with:
          name: ios-ipa
          path: app/app-release.ipa

  # ============================================
  # Build Web
  # ============================================
  build-web:
    runs-on: ubuntu-latest
    needs: changelog
    steps:
      - uses: actions/checkout@v6

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v5
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-

      - name: Get dependencies
        run: |
          cd packages/core_domain && flutter pub get
          cd ../core_ui && flutter pub get
          cd ../core_data && flutter pub get
          cd ../core_ai && flutter pub get
          cd ../core_auth && flutter pub get
          cd ../../app && flutter pub get

      - name: Build Web
        run: |
          cd app
          flutter build web --release \
            --dart-define=ENV=prod \
            --dart-define=DEMO_MODE=false

      - name: Create Web Archive
        run: |
          cd app/build/web
          zip -r -q ../../airo-web-release.zip .

      - name: Upload Web
        uses: actions/upload-artifact@v5
        with:
          name: web-build
          path: app/airo-web-release.zip

  # ============================================
  # Build Windows
  # ============================================
  build-windows:
    runs-on: windows-latest
    needs: changelog
    steps:
      - uses: actions/checkout@v6

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: |
          cd packages/core_domain; flutter pub get
          cd ../core_ui; flutter pub get
          cd ../core_data; flutter pub get
          cd ../core_ai; flutter pub get
          cd ../core_auth; flutter pub get
          cd ../../app; flutter pub get

      - name: Build Windows
        run: |
          cd app
          flutter build windows --release

      - name: Create Windows Archive
        run: |
          cd app/build/windows/x64/runner/Release
          powershell Compress-Archive -Path . -DestinationPath ../../../../../airo-windows-release.zip

      - name: Upload Windows
        uses: actions/upload-artifact@v5
        with:
          name: windows-build
          path: app/airo-windows-release.zip

  # ============================================
  # Build Linux
  # ============================================
  build-linux:
    runs-on: ubuntu-latest
    needs: changelog
    steps:
      - uses: actions/checkout@v6

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v5
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libx11-dev pkg-config cmake ninja-build libblkid-dev

      - name: Get dependencies
        run: |
          cd packages/core_domain && flutter pub get
          cd ../core_ui && flutter pub get
          cd ../core_data && flutter pub get
          cd ../core_ai && flutter pub get
          cd ../core_auth && flutter pub get
          cd ../../app && flutter pub get

      - name: Build Linux
        run: |
          cd app
          flutter build linux --release \
            --dart-define=ENV=prod \
            --dart-define=DEMO_MODE=false

      - name: Create Linux Archive
        run: |
          cd app/build/linux/x64/release/bundle
          tar -czf ../../../../airo-linux-release.tar.gz .

      - name: Upload Linux
        uses: actions/upload-artifact@v5
        with:
          name: linux-build
          path: app/airo-linux-release.tar.gz

  # ============================================
  # Create GitHub Release
  # ============================================
  create-release:
    needs: [changelog, build-android, build-ios, build-web, build-windows, build-linux]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v6

      - name: Generate release notes
        run: |
          VERSION="${{ needs.changelog.outputs.version }}"
          CHANGELOG='${{ needs.changelog.outputs.changelog }}'

          cat > RELEASE_NOTES.md << EOF
          # Airo Super App ${VERSION}

          ## What's Changed

          ${CHANGELOG:-See commit history for changes.}

          ---

          ## ðŸ“¦ Available Downloads

          | Platform | File | Description |
          |----------|------|-------------|
          | Android | \`app-release.apk\` | Direct install on Android |
          | Android | \`app-release.aab\` | For Google Play Store |
          | iOS | \`app-release.ipa\` | Requires signing |
          | Web | \`airo-web-release.zip\` | Run in browser |
          | Windows | \`airo-windows-release.zip\` | Windows 10/11 |
          | Linux | \`airo-linux-release.tar.gz\` | Linux x64 |

          ## ðŸš€ Quick Start

          ### Android
          \`\`\`bash
          adb install app-release.apk
          \`\`\`

          ### Web
          Extract zip, open \`index.html\` in browser

          ## ðŸ“‹ Features
          - ðŸ’° Coins - Money management & bill splitting
          - ðŸ¤– Quest - AI-powered Q&A with Gemini Nano
          - ðŸŽµ Beats - Music streaming
          - ðŸŽ® Arena - Games
          - ðŸ·ï¸ Loot - Deals feed
          - ðŸ“– Tales - Reader

          ## ðŸ” Security
          - On-device AI (Pixel 9 Gemini Nano)
          - Encrypted local storage
          - HTTPS enforced

          ---
          *Built with Flutter ${{ env.FLUTTER_VERSION }}*
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.changelog.outputs.version }}
          name: Airo ${{ needs.changelog.outputs.version }}
          files: |
            android-apk/app-release.apk
            android-aab/app-release.aab
            ios-ipa/app-release.ipa
            web-build/airo-web-release.zip
            windows-build/airo-windows-release.zip
            linux-build/airo-linux-release.tar.gz
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
