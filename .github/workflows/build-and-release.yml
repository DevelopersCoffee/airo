name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
      prerelease:
        description: 'Is this a pre-release?'
        required: false
        default: false
        type: boolean

env:
  FLUTTER_VERSION: '3.35.7'

jobs:
  # ============================================
  # Generate Changelog
  # ============================================
  changelog:
    runs-on: ubuntu-latest
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        id: changelog
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --latest --strip header
        continue-on-error: true

      - name: Fallback changelog
        if: steps.changelog.outcome == 'failure'
        run: |
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "## What's Changed" >> $GITHUB_OUTPUT
          git log --oneline -20 >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # ============================================
  # Build Android ARM64 (APK + AAB) - Modern 64-bit devices
  # This is the primary Android build - includes AAB for Play Store
  # ============================================
  build-android-arm64:
    runs-on: ubuntu-latest
    needs: changelog
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v5
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-

      - name: Cache Gradle
        uses: actions/cache@v5
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-arm64-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: gradle-${{ runner.os }}-

      - name: Create Firebase Config
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        if: env.GOOGLE_SERVICES_JSON != ''
        run: |
          cd app
          echo '${{ secrets.GOOGLE_SERVICES_JSON }}' | base64 -d > android/app/google-services.json

      - name: Get dependencies
        run: |
          cd packages/core_domain && flutter pub get
          cd ../core_ui && flutter pub get
          cd ../core_data && flutter pub get
          cd ../core_ai && flutter pub get
          cd ../core_auth && flutter pub get
          cd ../../app && flutter pub get

      - name: Build APK (arm64-v8a)
        run: |
          cd app
          export GRADLE_OPTS="-Dorg.gradle.watch.fs=false -Xmx4g -Dorg.gradle.parallel=true"
          flutter build apk --release \
            --target-platform android-arm64 \
            --dart-define=ENV=prod \
            --dart-define=DEMO_MODE=false

      - name: Build AAB (Release - All ABIs)
        run: |
          cd app
          export GRADLE_OPTS="-Dorg.gradle.watch.fs=false -Xmx4g -Dorg.gradle.parallel=true"
          flutter build appbundle --release \
            --dart-define=ENV=prod \
            --dart-define=DEMO_MODE=false

      - name: Rename artifacts with version
        run: |
          VERSION="${{ needs.changelog.outputs.version }}"
          cd app/build/app/outputs/flutter-apk
          mv app-release.apk "airo-${VERSION}-arm64-v8a.apk"
          cd ../../bundle/release
          mv app-release.aab "airo-${VERSION}.aab"

      - name: Upload APK (arm64-v8a)
        uses: actions/upload-artifact@v6
        with:
          name: android-apk-arm64
          path: app/build/app/outputs/flutter-apk/airo-*-arm64-v8a.apk

      - name: Upload AAB
        uses: actions/upload-artifact@v6
        with:
          name: android-aab
          path: app/build/app/outputs/bundle/release/airo-*.aab

  # ============================================
  # Build Android ARM32 (APK) - Older 32-bit devices
  # ============================================
  build-android-arm32:
    runs-on: ubuntu-latest
    needs: changelog
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v5
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-

      - name: Cache Gradle
        uses: actions/cache@v5
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-arm32-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: gradle-${{ runner.os }}-

      - name: Create Firebase Config
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        if: env.GOOGLE_SERVICES_JSON != ''
        run: |
          cd app
          echo '${{ secrets.GOOGLE_SERVICES_JSON }}' | base64 -d > android/app/google-services.json

      - name: Get dependencies
        run: |
          cd packages/core_domain && flutter pub get
          cd ../core_ui && flutter pub get
          cd ../core_data && flutter pub get
          cd ../core_ai && flutter pub get
          cd ../core_auth && flutter pub get
          cd ../../app && flutter pub get

      - name: Build APK (armeabi-v7a)
        run: |
          cd app
          export GRADLE_OPTS="-Dorg.gradle.watch.fs=false -Xmx4g -Dorg.gradle.parallel=true"
          flutter build apk --release \
            --target-platform android-arm \
            --dart-define=ENV=prod \
            --dart-define=DEMO_MODE=false

      - name: Rename APK with version
        run: |
          VERSION="${{ needs.changelog.outputs.version }}"
          cd app/build/app/outputs/flutter-apk
          mv app-release.apk "airo-${VERSION}-armeabi-v7a.apk"

      - name: Upload APK (armeabi-v7a)
        uses: actions/upload-artifact@v6
        with:
          name: android-apk-arm32
          path: app/build/app/outputs/flutter-apk/airo-*-armeabi-v7a.apk

  # ============================================
  # Build Android x86_64 (APK) - Emulators/Chromebooks
  # ============================================
  build-android-x64:
    runs-on: ubuntu-latest
    needs: changelog
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v5
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-

      - name: Cache Gradle
        uses: actions/cache@v5
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-x64-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: gradle-${{ runner.os }}-

      - name: Create Firebase Config
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        if: env.GOOGLE_SERVICES_JSON != ''
        run: |
          cd app
          echo '${{ secrets.GOOGLE_SERVICES_JSON }}' | base64 -d > android/app/google-services.json

      - name: Get dependencies
        run: |
          cd packages/core_domain && flutter pub get
          cd ../core_ui && flutter pub get
          cd ../core_data && flutter pub get
          cd ../core_ai && flutter pub get
          cd ../core_auth && flutter pub get
          cd ../../app && flutter pub get

      - name: Build APK (x86_64)
        run: |
          cd app
          export GRADLE_OPTS="-Dorg.gradle.watch.fs=false -Xmx4g -Dorg.gradle.parallel=true"
          flutter build apk --release \
            --target-platform android-x64 \
            --dart-define=ENV=prod \
            --dart-define=DEMO_MODE=false

      - name: Rename APK with version
        run: |
          VERSION="${{ needs.changelog.outputs.version }}"
          cd app/build/app/outputs/flutter-apk
          mv app-release.apk "airo-${VERSION}-x86_64.apk"

      - name: Upload APK (x86_64)
        uses: actions/upload-artifact@v6
        with:
          name: android-apk-x64
          path: app/build/app/outputs/flutter-apk/airo-*-x86_64.apk

  # ============================================
  # Build iOS
  # NOTE: Currently disabled due to stockfish NNUE file issue (see issue #51)
  # The stockfish package fails to compile on iOS because NNUE files are not embedded
  # ============================================
  build-ios:
    runs-on: macos-latest
    needs: changelog
    # Allow iOS build to fail - stockfish has NNUE embedding issues on iOS
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v5
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-

      - name: Get dependencies
        run: |
          cd packages/core_domain && flutter pub get
          cd ../core_ui && flutter pub get
          cd ../core_data && flutter pub get
          cd ../core_ai && flutter pub get
          cd ../core_auth && flutter pub get
          cd ../../app && flutter pub get

      - name: Build iOS
        run: |
          cd app
          flutter build ios --release --no-codesign \
            --dart-define=ENV=prod \
            --dart-define=DEMO_MODE=false

      - name: Create IPA
        run: |
          VERSION="${{ needs.changelog.outputs.version }}"
          cd app/build/ios/Release-iphoneos
          mkdir -p Payload
          mv Runner.app Payload/
          zip -r -q "airo-${VERSION}-ios.ipa" Payload
          mv "airo-${VERSION}-ios.ipa" ../../../

      - name: Upload IPA
        uses: actions/upload-artifact@v6
        with:
          name: ios-ipa
          path: app/airo-*-ios.ipa

  # ============================================
  # Build Web
  # ============================================
  build-web:
    runs-on: ubuntu-latest
    needs: changelog
    steps:
      - uses: actions/checkout@v6

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v5
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-

      - name: Get dependencies
        run: |
          cd packages/core_domain && flutter pub get
          cd ../core_ui && flutter pub get
          cd ../core_data && flutter pub get
          cd ../core_ai && flutter pub get
          cd ../core_auth && flutter pub get
          cd ../../app && flutter pub get

      - name: Build Web
        run: |
          cd app
          flutter build web --release \
            --dart-define=ENV=prod \
            --dart-define=DEMO_MODE=false

      - name: Create Web Archive
        run: |
          VERSION="${{ needs.changelog.outputs.version }}"
          cd app/build/web
          zip -r -q "../../airo-${VERSION}-web.zip" .

      - name: Upload Web
        uses: actions/upload-artifact@v6
        with:
          name: web-build
          path: app/airo-*-web.zip

  # ============================================
  # Build Windows
  # ============================================
  build-windows:
    runs-on: windows-latest
    needs: changelog
    steps:
      - uses: actions/checkout@v6

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: |
          cd packages/core_domain; flutter pub get
          cd ../core_ui; flutter pub get
          cd ../core_data; flutter pub get
          cd ../core_ai; flutter pub get
          cd ../core_auth; flutter pub get
          cd ../../app; flutter pub get

      - name: Build Windows
        run: |
          cd app
          flutter build windows --release

      - name: Create Windows Archive
        run: |
          $VERSION = "${{ needs.changelog.outputs.version }}"
          cd app/build/windows/x64/runner/Release
          powershell Compress-Archive -Path . -DestinationPath "../../../../../airo-${VERSION}-windows-x64.zip"

      - name: Upload Windows
        uses: actions/upload-artifact@v6
        with:
          name: windows-build
          path: app/airo-*-windows-x64.zip

  # ============================================
  # Build Linux
  # ============================================
  build-linux:
    runs-on: ubuntu-latest
    needs: changelog
    steps:
      - uses: actions/checkout@v6

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v5
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libx11-dev pkg-config cmake ninja-build libblkid-dev libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libsecret-1-dev libjsoncpp-dev

      - name: Get dependencies
        run: |
          cd packages/core_domain && flutter pub get
          cd ../core_ui && flutter pub get
          cd ../core_data && flutter pub get
          cd ../core_ai && flutter pub get
          cd ../core_auth && flutter pub get
          cd ../../app && flutter pub get

      - name: Build Linux
        run: |
          cd app
          flutter build linux --release \
            --dart-define=ENV=prod \
            --dart-define=DEMO_MODE=false

      - name: Create Linux Archive
        run: |
          VERSION="${{ needs.changelog.outputs.version }}"
          cd app/build/linux/x64/release/bundle
          tar -czf "../../../../airo-${VERSION}-linux-x64.tar.gz" .

      - name: Upload Linux
        uses: actions/upload-artifact@v6
        with:
          name: linux-build
          path: app/airo-*-linux-x64.tar.gz

  # ============================================
  # Create GitHub Release
  # ============================================
  create-release:
    needs: [changelog, build-android-arm64, build-android-arm32, build-android-x64, build-ios, build-web, build-windows, build-linux]
    runs-on: ubuntu-latest
    # Always run release creation, even if some builds fail (iOS/Android have known issues)
    if: always() && needs.changelog.result == 'success'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        continue-on-error: true

      - name: Generate release notes
        run: |
          VERSION="${{ needs.changelog.outputs.version }}"
          CHANGELOG='${{ needs.changelog.outputs.changelog }}'

          cat > RELEASE_NOTES.md << EOF
          # Airo Super App ${VERSION}

          ## What's Changed

          ${CHANGELOG:-See commit history for changes.}

          ---

          ## ðŸ“¦ Available Downloads

          | Platform | File | Description |
          |----------|------|-------------|
          | Android | \`airo-${VERSION}-arm64-v8a.apk\` | For modern 64-bit devices (recommended) |
          | Android | \`airo-${VERSION}-armeabi-v7a.apk\` | For older 32-bit devices |
          | Android | \`airo-${VERSION}-x86_64.apk\` | For emulators/Chromebooks |
          | Android | \`airo-${VERSION}.aab\` | For Google Play Store |
          | iOS | \`airo-${VERSION}-ios.ipa\` | Requires signing (may be unavailable) |
          | Web | \`airo-${VERSION}-web.zip\` | Run in browser |
          | Windows | \`airo-${VERSION}-windows-x64.zip\` | Windows 10/11 |
          | Linux | \`airo-${VERSION}-linux-x64.tar.gz\` | Linux x64 |

          > **Note**: iOS build may be unavailable due to a known upstream issue with the Stockfish chess engine package.

          ## ðŸš€ Quick Start

          ### Android
          \`\`\`bash
          # For most modern devices (Pixel, Samsung Galaxy S/A series, etc.)
          adb install airo-${VERSION}-arm64-v8a.apk
          # For older 32-bit devices
          adb install airo-${VERSION}-armeabi-v7a.apk
          # For emulators or Chromebooks
          adb install airo-${VERSION}-x86_64.apk
          \`\`\`

          ### Web
          Extract zip, open \`index.html\` in browser

          ## ðŸ“‹ Features
          - ðŸ’° Coins - Money management & bill splitting
          - ðŸ¤– Mind - AI-powered Q&A with Gemini Nano
          - ðŸŽµ Live - Music & IPTV streaming
          - ðŸŽ® Arena - Games
          - ðŸ“– Tales - Reader

          ## ðŸ” Security
          - On-device AI (Pixel 9 Gemini Nano)
          - Encrypted local storage
          - HTTPS enforced

          ---
          *Built with Flutter ${{ env.FLUTTER_VERSION }}*
          EOF

      - name: List downloaded artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          find . -type f -name "airo-*" | head -50

      - name: Collect available artifacts
        id: collect-artifacts
        run: |
          echo "=== Collecting available artifacts ==="
          # Create a file list of all available artifacts
          find . -type f -name "airo-*" > artifact_files.txt
          cat artifact_files.txt

          # Build file list for release (only include files that exist)
          FILES=""
          for pattern in \
            "android-apk-arm64/airo-*-arm64-v8a.apk" \
            "android-apk-arm32/airo-*-armeabi-v7a.apk" \
            "android-aab/airo-*.aab" \
            "ios-ipa/airo-*-ios.ipa" \
            "web-build/airo-*-web.zip" \
            "windows-build/airo-*-windows-x64.zip" \
            "linux-build/airo-*-linux-x64.tar.gz"; do
            for file in $pattern; do
              if [ -f "$file" ]; then
                FILES="${FILES}${file}\n"
                echo "Found: $file"
              fi
            done
          done

          # Save file list (newline separated)
          echo -e "$FILES" > release_files.txt
          echo "files<<EOF" >> $GITHUB_OUTPUT
          cat release_files.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.changelog.outputs.version }}
          name: Airo Super App ${{ needs.changelog.outputs.version }}
          files: |
            android-apk-arm64/airo-*-arm64-v8a.apk
            android-apk-arm32/airo-*-armeabi-v7a.apk
            android-aab/airo-*.aab
            ios-ipa/airo-*-ios.ipa
            web-build/airo-*-web.zip
            windows-build/airo-*-windows-x64.zip
            linux-build/airo-*-linux-x64.tar.gz
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
